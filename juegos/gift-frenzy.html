<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ivandfx | Gift Frenzy</title>
  <link rel="stylesheet" href="/style.css">

  <style>
    .game-wrapper {
      max-width: 900px;
      margin: 20px auto;
      background: linear-gradient(180deg,#052a1f 0%, #063a2b 100%);
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
      color: #fff;
      outline: 2px solid #ffffff1e;
    }

    .game-top {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .hud {
      display:flex;
      gap:12px;
      align-items:center;
      font-weight:600;
      font-size:0.95rem;
    }

    .hud .label { opacity:0.85; font-weight:500; font-size:0.85rem }

    #game-canvas {
      display:block;
      width:100%;
      aspect-ratio: 16/10;
      background: linear-gradient(#0a3f2e, #073325);
      border-radius: 12px;
      box-shadow: inset 0 2px 20px rgba(0,0,0,0.5);
    }

    .game-footer {
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      font-size:0.9rem;
      opacity:0.95;
      gap:12px;
      flex-wrap:wrap;
    }

    .controls {
      background: rgba(255,255,255,0.03);
      padding:8px 10px;
      border-radius:8px;
      font-size:0.85rem;
    }

    .big {
      font-size:1.2rem;
      font-weight:700;
      letter-spacing:0.6px;
    }

    .btn {
      background: rgba(255,255,255,0.06);
      color: #fff;
      padding:8px 12px;
      border-radius:8px;
      border: none;
      cursor:pointer;
      font-weight:600;
    }

    .btn:active { transform: translateY(1px) }
    .muted { opacity:0.8; font-size:0.86rem; }

    #unsupported-message {
      display:none;
      background:#300;
      color:#fff;
      padding:16px;
      border-radius:12px;
      text-align:center;
      max-width:900px;
      margin:20px auto;
      font-size:1rem;
    }

    @media (max-width: 768px) {
      .game-wrapper { display: none !important; }
      #unsupported-message { display: block !important; }
    }
  </style>
</head>

<body>
  <div id="topnav-container"></div>
  <div class="page-wrapper">
  <a class="msg-banner">¡Ten cuidado, no te vicies!</a>
  <div id="sidebar-container"></div>
  <main>

<h1>DFX Originals: Gift Frenzy</h1>

<div id="unsupported-message">La resolución de pantalla no es compatible con el juego.</div>

<section class="game-wrapper" aria-label="Juego de Navidad">
  <div class="game-top">
    <div class="hud">
      <div><span class="label">Regalos:</span> <span id="score" class="big">0</span></div>
      <div><span class="label">Vidas:</span> <span id="lives" class="big">3</span></div>
      <div><span class="label">Tiempo:</span> <span id="time" class="big">60</span>s</div>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button id="startBtn" class="btn">Iniciar</button>
      <button id="resetBtn" class="btn">Reiniciar</button>
    </div>
  </div>

  <canvas id="game-canvas" width="1280" height="800" tabindex="0"></canvas>

  <div class="game-footer">
    <div class="controls">
      Controles: usa las <strong>flechas del teclado</strong> para mover a Papá Noel. 
      Deberás recoger la mayor cantidad de regalos en 60 segundos. Evita los carbones o perderás vida.
    </div>
  </div>
</section>

  </main>
  </div>

<script>
(() => {
  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d', { alpha: false });
  const scoreEl = document.getElementById('score');
  const livesEl = document.getElementById('lives');
  const timeEl = document.getElementById('time');
  const startBtn = document.getElementById('startBtn');
  const resetBtn = document.getElementById('resetBtn');

  const GAME_TIME = 60;
  const PLAYER_SPEED = 320;
  const SPAWN_INTERVAL = 900;
  const FALL_SPEED_MIN = 80;
  const FALL_SPEED_MAX = 220;
  const GIFT_VALUE = 10;
  const INITIAL_LIVES = 3;

  let lastTs = 0;
  let accSpawn = 0;
  let running = false;
  let score = 0;
  let lives = INITIAL_LIVES;
  let remaining = GAME_TIME;
  let items = [];
  const keys = { ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false };

  const player = {
    x: canvas.width/2,
    y: canvas.height - 120,
    w: 48,
    h: 60,
    speed: PLAYER_SPEED
  };

  function spawnItem() {
    const kind = Math.random() < 0.75 ? 'gift' : 'coal';
    const size = kind === 'gift' ? 28 + Math.random()*10 : 32 + Math.random()*8;
    const x = Math.random() * (canvas.width - size - 20) + 10;
    const speed = FALL_SPEED_MIN + Math.random() * (FALL_SPEED_MAX - FALL_SPEED_MIN);
    const y = -size - 10;
    items.push({ kind, x, y, size, speed });
  }

  function resetGame() {
    score = 0;
    lives = INITIAL_LIVES;
    remaining = GAME_TIME;
    items = [];
    running = false;
    lastTs = 0;
    accSpawn = 0;
    scoreEl.textContent = score;
    livesEl.textContent = lives;
    timeEl.textContent = remaining;
  }

  function startGame() {
    resetGame();
    running = true;
    lastTs = performance.now();
    requestAnimationFrame(loop);
    canvas.focus();
  }

  window.addEventListener('keydown', (e) => {
    if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
      e.preventDefault();
      keys[e.key] = true;
    }
  }, { passive: false });

  window.addEventListener('keyup', (e) => {
    if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
      keys[e.key] = false;
    }
  });

  function collide(a, b) {
    return !(a.x + a.w < b.x || a.x > b.x + b.size || a.y + a.h < b.y || a.y > b.y + b.size);
  }

  function drawPlayer(ctx) {
    const px = player.x;
    const py = player.y;
    const w = player.w;
    const h = player.h;
    ctx.fillStyle = '#c92a2a';
    roundRect(ctx, px - w/2, py - h/2 + 8, w, h - 8, 8);
    ctx.fill();
    ctx.fillStyle = '#ffd9b6';
    ctx.beginPath();
    ctx.ellipse(px, py - 6, w*0.32, h*0.22, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = '#e11d48';
    ctx.beginPath();
    ctx.moveTo(px - w*0.45, py - h*0.55);
    ctx.lineTo(px + w*0.48, py - h*0.35);
    ctx.lineTo(px - w*0.05, py - h*0.10);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle = '#fff';
    roundRect(ctx, px - w*0.45, py - h*0.35, w*0.9, 8, 6);
    ctx.fill();
    ctx.fillStyle = '#111';
    ctx.fillRect(px - 8, py - 12, 3, 3);
    ctx.fillRect(px + 5, py - 12, 3, 3);
  }

  function roundRect(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
  }

  function drawItem(ctx, it) {
    if (it.kind === 'gift') {
      ctx.fillStyle = '#2ecc71';
      roundRect(ctx, it.x, it.y, it.size, it.size, 6);
      ctx.fill();
      ctx.fillStyle = '#155724';
      ctx.fillRect(it.x + it.size*0.45, it.y+2, it.size*0.12, it.size-4);
      ctx.fillRect(it.x+2, it.y + it.size*0.45, it.size-4, it.size*0.12);
      ctx.beginPath();
      ctx.ellipse(it.x + it.size*0.5, it.y + it.size*0.5, it.size*0.12, it.size*0.08, 0, 0, Math.PI*2);
      ctx.fill();
    } else {
      ctx.fillStyle = '#2f2f2f';
      ctx.beginPath();
      const s = it.size;
      ctx.moveTo(it.x + s*0.5, it.y);
      ctx.lineTo(it.x + s*0.8, it.y + s*0.2);
      ctx.lineTo(it.x + s, it.y + s*0.45);
      ctx.lineTo(it.x + s*0.7, it.y + s*0.9);
      ctx.lineTo(it.x + s*0.3, it.y + s*0.85);
      ctx.lineTo(it.x + s*0.05, it.y + s*0.55);
      ctx.closePath();
      ctx.fill();
      ctx.strokeStyle = '#666';
      ctx.lineWidth = Math.max(1, s*0.05);
      ctx.stroke();
    }
  }

  function update(dt) {
    let dx = 0, dy = 0;
    if (keys.ArrowLeft) dx -= 1;
    if (keys.ArrowRight) dx += 1;
    if (keys.ArrowUp) dy -= 1;
    if (keys.ArrowDown) dy += 1;
    const len = Math.hypot(dx, dy) || 1;
    player.x += (dx/len) * player.speed * dt;
    player.y += (dy/len) * player.speed * dt;
    player.x = Math.max(player.w/2 + 8, Math.min(canvas.width - player.w/2 - 8, player.x));
    player.y = Math.max(player.h/2 + 8, Math.min(canvas.height - player.h/2 - 8, player.y));
    accSpawn += dt * 1000;
    if (accSpawn >= SPAWN_INTERVAL) {
      accSpawn = 0;
      spawnItem();
    }
    for (let i = items.length - 1; i >= 0; i--) {
      const it = items[i];
      it.y += it.speed * dt;
      const a = { x: player.x - player.w/2, y: player.y - player.h/2, w: player.w, h: player.h };
      if (collide(a, it)) {
        if (it.kind === 'gift') score += GIFT_VALUE;
        else lives -= 1;
        items.splice(i,1);
        scoreEl.textContent = score;
        livesEl.textContent = lives;
        if (lives <= 0) endGame(false);
        continue;
      }
      if (it.y > canvas.height + 80) items.splice(i,1);
    }
    remaining -= dt;
    const remInt = Math.max(0, Math.ceil(remaining));
    timeEl.textContent = remInt;
    if (remaining <= 0) endGame(true);
  }

  function endGame(win) {
    running = false;
    setTimeout(() => {
      const msg = win ? `¡Tiempo! Has conseguido ${score} puntos.` : `Has perdido todas las vidas. Puntos: ${score}`;
      alert(msg);
    }, 60);
  }

  function loop(ts) {
    if (!running) return;
    if (!lastTs) lastTs = ts;
    const dt = Math.min(0.05, (ts - lastTs) / 1000);
    lastTs = ts;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBackground(ctx);
    for (const it of items) {
      drawItem(ctx, it);
    }
    drawPlayer(ctx);
  }

  function drawBackground(ctx) {
    const w = canvas.width, h = canvas.height;
    ctx.fillStyle = '#071f12';
    ctx.fillRect(0, h - Math.round(h*0.12), w, Math.round(h*0.12));
    ctx.fillStyle = '#0a3b28';
    ctx.beginPath();
    ctx.moveTo(0, h - h*0.12);
    ctx.lineTo(w*0.18, h - h*0.45);
    ctx.lineTo(w*0.36, h - h*0.12);
    ctx.lineTo(w*0.5, h - h*0.5);
    ctx.lineTo(w*0.68, h - h*0.14);
    ctx.lineTo(w*0.9, h - h*0.4);
    ctx.lineTo(w, h - h*0.12);
    ctx.closePath();
    ctx.fill();
    for (let i = 0; i < 60; i++) {
      const x = (i * 97) % w;
      const y = ((i * 53) % h) * 0.4 + (Date.now() % 1000) * 0.06;
      ctx.fillStyle = 'rgba(255,255,255,0.08)';
      ctx.fillRect((x + (Date.now()*0.02 % 60)) % w, (y + (i*3)) % (h - 20), 2, 2);
    }
  }

  function initSizes() {
    function apply() {
      const rect = canvas.getBoundingClientRect();
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      canvas.width = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      player.x = Math.max(player.w/2 + 8, Math.min(canvas.width/dpr - player.w/2 - 8, player.x));
      player.y = Math.max(player.h/2 + 8, Math.min(canvas.height/dpr - player.h/2 - 8, player.y));
    }
    apply();
    window.addEventListener('resize', () => {
      apply();
      draw();
    });
  }

  startBtn.addEventListener('click', () => {
    if (!running) startGame();
  });

  resetBtn.addEventListener('click', () => {
    resetGame();
    draw();
  });

  resetGame();
  initSizes();
  draw();

  canvas.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      if (!running) startGame();
    }
  });

  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
      e.preventDefault();
      if (!running) startGame();
      else running = false;
    }
  });

})();
</script>

<script src="/loader.js"></script>
</body>
</html>
